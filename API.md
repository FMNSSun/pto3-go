# PAPI

Path Transparency Observatory API (PAPI) specifiation, version 3

**NOTE** as of this commit the code in package `github.com/mami-project/pto3-go` does not yet fully implement this specification.

The P consists of four applications: raw data access and upload, observation
access, observation query, and data analysis control. The interface to each
application is made up of certain resources accessed in a RESTful way; these
resources are specified below.

# Access Control and Permissions

[ISSUE: document JSON Web Token based authentication]

# Raw Data Access and Upload

The raw data access and upload API (resources under `/raw`) allows the upload of
raw data files to the PTO, and the later retrieval of those files. Each file is
associated with a *campaign* -- a group of files related to a single measurement
campaign from a single data source. Campaigns and files have associated
*metadata* which is used by the PTO and analysis modules to save metadata about
the raw data; this may also be used by users of the PTO to store information
about raw files and campaigns. 

The resources and methods available thereon are summarized in the table below.

| Method   | Resource              | Permission      | Description                                   |
| -------- | --------------------- | --------------- | --------------------------------------------- |
| `GET`    | `/raw`                | `list_raw`      | Retrieve URLs for campaigns as JSON           |
| `GET`    | `/raw/<c>`            | `read_raw:<c>`  | Retrieve metadata for campaign *c* as JSON    |
| `PUT`    | `/raw/<c>`            | `write_raw:<c>` | Write metadata for campaign *c* as JSON       |
| `GET`    | `/raw/<c>/<f>`        | `read_raw:<c>`  | Retrieve metadata for file *f* in *c* as JSON |
| `PUT`    | `/raw/<c>/<f>`        | `write_raw:<c>` | Write metadata for file *f* in *c* as JSON    |
| `GET`    | `/raw/<c>/<f>/data`   | `read_raw:<c>`  | Retrieve content for file *f* in *c* (by convention) |
| `PUT`    | `/raw/<c>/<f>/data`   | `write_raw:<c>` | Write content for file *f* in *c*  (by convention) |
| `DELETE` | `/raw/<c>/<f>`        | `write_raw:<c>` | Delete a file and its metadata                |
| `DELETE` | `/raw/<c>`            | `write_raw:<c>` | Delete a campaign and all its files           |

## Metadata

Associated with each file and each campaign in the raw data store is a *metadata
object*. This metadata object is a set of key-value pairs, presented by the API
as a JSON object. Certain keys in this object are reserved for use by the
system, or are generated by the system. Other metadata keys can be freely used
by the creator of a raw data file to communicate metadata information with a
future analysis process that will be run on the raw data, or for future
retrieval of the file. Metadata key behavior is determined by the metadata key
name:

- All metadata keys whose names begin with an underscore `_` are reserved for
  system use; they may be written to, but have a special meaning to the PTO itself. 
- All metadata keys whose names begin with `__` are virtual, and
  generated by the system; they may not be written to.
- All other metadata key names are free for use by users and analysis modules.

Files inherit metadata from their containing campaign. If a file's metadata and
its containing campaign's metadata have metadata for the same key, the value
associated with file overrides that inherited from the campaign for that file.

The following reserved and virtual metadata keys are presently supported:

| Key             | Description                                                             |
| --------------- | ----------------------------------------------------------------------- |
| `_file_type`    | PTO filetype. See Filetypes, below.                                     |
| `_owner`        | Identity of user or organization owning the file/campaign               |
| `_time_start`   | Timestamp of first observation in the raw data file, in ISO8601 format  |
| `_time_end`     | Time of last observation in the raw data file, in ISO8601 format        |
| `__data`        | URL of the resource containing file data.                               |
| `__data_size`   | Size of the file in bytes. 0 if the data file has not been uploaded.    |

[ISSUE: files and campaigns have owner identities]

Though the data resource is by convention accessible by appending `/data` to the
path of the metadata resource, the system may at any time place data at another
path; therefore, clients should only upload data to the path given in the
`__data` metadata key.

### Filetypes

Every raw data file has a *filetype*, given in the `_file_type` key, which the
PTO uses to determine how to handle files internally, and which analysis modules
use to determine how to read and whether they are interested in raw data files.
Each filetype is associated with a MIME type, and the `Content-Type` header on
data uploads via PUT must match the filetype associated with the file. 

Often, all the files within a campaign will share the same filetype. In this
case, filetype information is set in campaign metadata, not in individual file
metadata.

While filetypes are extensible, the filetypes supported by the PTO as installed
are listed below:

| Filetype            | MIME type                     | Description                                   |
| ------------------- | ------------------------------|---------------------------------------------- |
| `obs-ndjson-bz2`    | `application/bzip2`           | Compressed observations in [OSF](OBSETS.md) |
| `obs-ndjson`        | `application/vnd.mami.ndjson` | Uncompressed observations in [OSF](OBSETS.md) |
| `ps-ecn-ndjson-bz2` | `application/bzip2`           | Compressed [PATHspider](https://pathspider.net) ECN results             |
| `ps-ecn-ndjson`     | `application/vnd.mami.ndjson` | Uncompressed [PATHspider](https://pathspider.net) ECN results           |

## API usage

We use [curl](https://curl.haxx.se) to illustrate the usage of the PTO raw API.
We assume the PAPI API is rooted at `https://pto.example.com/`, and that the API
key `12345` holds the permissions `list_raw`, `read_raw:test`, and
`write_raw:test`.

## Creating and listing campaigns

In order to upload raw data files, a campaign to contain the files must be
created first. To create a campaign, we simply PUT the metadata of the campaign.
Let's assume this campaign will contain only PATHspider ECN data, uncompressed,
so we can associate the filetype with the campaign. Let's also add a description
for the campaign, to illustrate the usage of freeform metadata:

```
$ curl -X PUT
       -H "Authorization: APIKEY 12345"
       -H "Content-type: application/json"
       --data '{"_file_type": "ps-ecn-ndjson", "description": "an example campaign"}'
       https://pto.example.com/raw/test
```

We can now retrieve the campaign to verify it was created:

```
$ curl -H "Authorization: APIKEY 12345" https://pto.example.com/raw/test

{
  "files": [],
  "metadata": {
    "_file_type": "ps-ecn-ndjson",
    "description": "an example campaign"
  },
  "url": "https://pto.example.com/raw/test"
}
```

Here we see the campaign, its metadata, and an empty list of files. 

## Uploading Raw Data

write me

## Downloading Raw Data

write me

## Deleting Files

write me

# Observation Access
 
The observation access API (resources under `/obs`) allows access to PTO
*observations*. An observation is a tuple consisting of the following elements:

- a time interval during which the observation is valid, consisting of a 
  _start time_ and an _end time_;
- a _path_ on which the observation is made, consisting of a sequence of 
  _path elements_;
- a _condition_ observed on this path; and 
- an optional _value_ associated with the condition.

Observations are grouped into *observation sets*. An observation set is a set of
observations resulting from a single run of an analyser on some input data (see
Data Analysis, below). All observations in an observation set share the same
metadata and *provenance*. Provenance provides information about the source data
that was analyzed (in terms of raw data files and/or other observation sets
stored in the PTO) and the analysis that was performed.

The resources and methods available thereon are summarized in the table below.

| Method   | Resource        | Permission | Description                                           |
| -------- | --------------- | ---------- | ----------------------------------------------------- |
| `GET`    | `/obs`          | `list_obs` | Retrieve URLs for observation sets as JSON            |
| `POST`    | `/obs/create`  | `write_obs` | Create new observation set                         |
| `GET`    | `/obs/<o>`      | `read_obs` | Retrieve metadata and provenance for *o* as JSON      |
| `PUT`    | `/obs/<o>`      | `write_obs` | Write metadata and provenance for *o* as JSON      |
| `GET`    | `/obs/<o>/data` | `read_obs` | Retrieve obset file for *o* as NDJSON (by convention) |
| `PUT`    | `/obs/<o>/data` | `read_obs` | Upload obset file for *o* as NDJSON (by convention) |

## Metadata and Provenance

As with raw data files, observation sets have associated metadata; as with raw
data files, arbitrary metadata can be set on observation sets by the analyses
that create them. The same rules for reserved and virtual metadata names apply
for observation sets as for raw data. The metadata for an observation set also
contains information about the observation set's provenance.

Provenance is tracked by three metadata keys. `_sources` is an array of URLs
referencing the raw data file or the observation set(s) from which the
observations in an observation set are derived. `_analyzer` is a URL referring
to the analyzer that created the observation set. `_campaign` is a URL referring
to the campaign from which the original raw data was derived, and is only
present if the observation set is derived only from observation sets / raw data
in the same campaign.

The following reserved and virtual metadata keys are presently supported:

| Key             | Description                                                  |
| --------------- | ------------------------------------------------------------ |
| `_sources`      | Array of PTO URLs of raw data sources and observation sets   |
| `_analyzer`     | PTO URL of analyzer                                         |
| `_campaign`     | PTO URL of campaign from which raw data ultimately derived   |
| `__conditions`  | Array of all conditions present in the observation set       |
| `__obs_count`   | Count of observations in the observation set                 |
| `__data`        | URL of the resource containing observation set data          |

# Observation Query

The observation query API (resources under `/query`) allows the submission of
*queries* to the PTO, to retrieve observations and observation aggregates
meeting certain criteria from the PTO's observation database. 

| Method   | Resource            | Permission      | Description                                            |
| -------- | ------------------- | --------------- | ------------------------------------------------------ |
| `POST` or `GET` | `/query/submit` | `submit_query`  | Submit a query                                         |
| `GET`    | `/query`            | `read_query`    | List currently cached and pending queries              |
| `GET`    | `/query/<q>`        | `read_query`    | Get query metadata, including ETA for pending queries  |
| `GET`    | `/query/<q>/result` | `read_query`    | Get query results (by convention)                      |
| `PUT`    | `/query/<q>`        | `update_query`  | Update query metadata                                  |

Queries can be submitted by POSTing to the /query/submit resource. The query
itself is defined by a the parameters in the POSTed
`application/x-www-form-urlencoded` content. The parameters are summarized
below:

| Parameter       | Semantics | Multiple? | Meaning                                                          |
| --------------- | --------- | --------- | ---------------------------------------------------------------- |
| `time_start`    | temporal  | no        | Select observations starting at or after the given start time    |
| `time_end`      | temporal  | no        | Select observations ending at or before the given end time       |
| `campaign`      | select    | yes       | Select observations deriving from a given campaign               |
| `set`           | select    | yes       | Select observations with in the given set ID                     |
| `on_path`       | select    | yes       | Select observations with the given element in the path           | 
| `source`        | select    | yes       | Select observations with the given element at the start of the path |
| `destination`   | select    | yes       | Select observations with the given element at the end of the path |
| `condition`     | select    | yes       | Select observations with the given condition, with wildcards      |
| `group_by`      | group     | yes       | Group observations and return counts by group  |
| `intersect_condition` | set | yes       | Group observations by path, select paths by set intersection on conditions |

All parameters with temporal semantics must be present, and are used to bound
the query in time. Parameters with select semantics may be given to filter
observations. if multiple instances of a select parameter are available, any of
the values will match; however, an observation must match at least one of the
values for each distinct parameter given (i.e., the query language supports AND
of OR semantics). Parameters with group or set semantics modify the type of
query as in the subsections below.

## Observation Selection Queries

A query created without any `group_by` or `intersect_condition` parameters is a
selection query. The observations returned by this query are those within the
interval between the `time_start` and `time_end` parameters which match the selection parameters.

[ISSUE: matching rules go here, describe condition wildcards.]

The result of a selection query is a JSON object, the fields of which are as follows:

| Key            | Value 
| -------------- | ----------------------------------------------------|
| `prev`         | Link to previous page (see Pagination)              |
| `next`         | Link to next page (see Pagination)                  |
| `obs`          | JSON array containing observations in [OSF format](OBSETS.md) |

## Condition Set Intersection Queries

A query created with one or more `intersect_condition` parameters is a set
intersection query. First, observations matching the selection parameters are
selected. Then, the observations are grouped by paths, and only paths within each set listed in
`intersect_condition` parameters are selected. 

An `intersect_condition` parameter is either a full condition name (i.e.,
without wildcards), or a full condition name prefixed with the character `!`
(urlencoded `%21`). In the former case, the set is of all paths for which there
is at least one observation with the specified condition. In the latter case,
the set is negated, i.e. the set of all paths foe which there are no
observations with the specified condition. Foe example, a query with two
`intersect_condition` parameters with values `foo.bar` and `!foo.baz` will
select paths where there is at least one `foo.bar` observation and no `foo.baz`
observations.


The result of a set intersection query is a JSON object, the fields of which are as follows:

| Key            | Value 
| -------------- | ----------------------------------------------------|
| `prev`         | Link to previous page (see Pagination)              |
| `next`         | Link to next page (see Pagination)                  |
| `paths`          | JSON array containing paths as JSON arrays        |

## Aggregation Queries

A query created with one or more `group_by` parameters is an aggregation query.
The results will return the count of obsevations selected by the select
parameters for each group parameter. The following `group_by` parameters are
available:

| Value         | Meaning                                            |
| ------------- | -------------------------------------------------- |
| `year`        | Count by year of start_time                        | 
| `month`       | Count by year/month of start_time                  |
| `day`         | Count by year/month/day of start_time              |
| `hour`        | Count by year/month/day/hour of start_time         |
| `week`        | Count by year/week (starting Monday) of start_time |
| `week_day`    | Count by day of week of start_time (7 groups)      |
| `day_hour`    | Count by hour of day of start_time (24 groups)     | 
| `condition`   | Count by condition                                 |
| `source`      | Count by first element in path                     |
| `destination` | Count by last element in path                      |

The result of an aggregation query is a JSON object, the fields of which are as follows:

| Key            | Value                                               |
| -------------- | ----------------------------------------------------|
| `prev`         | Link to previous page (see Pagination)              |
| `next`         | Link to next page (see Pagination)                  |
| `groups`       | [ISSUE: determine best way to represent this]       |

## Metadata

front matter

| Key             | Description                                                  |
| --------------- | ------------------------------------------------------------ |
| `_state`        | Query state; see below                                       |
| `_sources`      | Array of PTO URLs of observation sets covered by the query   |
| `__parameters`  | Parameters from which the query was generated                |
| `__result`      | URL of the resource containing complete result, when available |

| State           | Meaning                                 |
| --------------- | --------------------------------------- |
| `submitted`     | Submitted, but not yet running          |
| `pending`       | Running and awaiting results            |
| `failed`        | Abnormally ended without returning results |
| `complete`      | Results are available                   |
| `permanent`     | Results are available and cached results will be stored permanently |


# Data Analysis

The data analysis API (resources under `/analysis`) allows the submission of
*analysis requests* to the PTO, as well as retrieval of information about
analyzers and analyses that have been run (the *analysis log*)

Analyses are performed by *analyzers*, the interface to which is described in
[ANALYSIS.md](ANALYSIS.md). 

| Method   | Resource            | Permission      | Description                                            |
| -------- | ------------------- | --------------- | ------------------------------------------------------ |
| `GET`    | `/analysis`         | tbd             | Retrieve URLs for installed analyzers as JSON          |
| `GET`    | `/analysis/<a>`     | tbd             | Retrieve metadata and log for installed analyzer *a*   |
| `POST` or `GET`  | `/analysis/<a>/submit` | tbd             | Submit a request to <a> (see Analysis Requests)        |
| `GET`    | `/analysis/<a>/<r>` | tbd             | Retrieve information about an analysis request         |

## Analyzer Metadata

write me

## Analysis Requests

write me

## Analysis Log

write me

# Pagination

API resources which return lists of URLs or results in arrays in JSON objects
support *pagination*. By default, if more than 20 items will be returned in the
list around which a resource is centered, the results will be paginated: the
top-level JSON object will gain a `next` key if the result is not the last page,
and a `prev` key if the result is not the first page. Pagination is controlled
using the following GET parameters:

| Parameter     | Meaning                                                           |
| ------------- | ----------------------------------------------------------------- |
| `page`        | Page number, beginning with 0. Defaults to 0                      |
| `pagination`  | Count of items per page. Default is resource-specific. If 0, disable pagination |

Pagination is applied to the following elements on the following resources:

| Resource            | Element paginated   | Pagination default |
| ------------------- | ------------------- | ------------------ |
| `/raw`              | `campaigns`         | tbd                |
| `/raw/<c>`          | `files`             | tbd                |
| `/obs`              | `sets`              | tbd                |
| `/analysis`         | `analyzers`         | tbd                |
| `/analysis/<a>`     | `analyses`          | tbd                |
| `/query`            | `queries`           | tbd                |
| `/query/<q>/result` | `results`           | tbd                |
