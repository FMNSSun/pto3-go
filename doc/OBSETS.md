# Observation Set File Format

Observation sets are accessible in the PTO API, and provided to and generated by
analyzers in the analyzer interface, as Observation Set Files (OSF). An OSF is a
newline-delimited JSON (ndjson) file where each line contains either an
observation or an observation set metadata objects.

## Data Elements

JSON arrays in the file are treated as observations. An array has five or six
elements, with the following semantics and format:

| Position | Description                                               |
| -------- | --------------------------------------------------------- |
| 0        | Observation Set Identifier, a string                      |
| 1        | Start time in RFC 3339 format                             |
| 2        | End time in RFC 3339 format                               |
| 3        | Path, as defined below                                    |
| 4        | Condition, as a JSON string                               |
| 5        | Value associated with condition, optional                 |

A *path* is a sequence of path elements. It can be represented either as a JSON
array of strings, each one a path element; or as a JSON string containing a
whitespace-separated sequence of path elements. The PTO currently generates only
space-separated path strings, but accepts and may generate either in the future.

*Path elements* identify hops along the path. The
type of path element is implied by its format; the following path element types
are currently supported:

| Format              | Description                                     |
| ------------------- | ----------------------------------------------- |
| the string `*`      | zero or more unknown hops on a path             |
| _NNN_`.`_NNN_`.`_NNN_`.`_NNN_ | IPv4 address                          |
| _NNN_`.`_NNN_`.`_NNN_`.`_NNN_`/`_NN_ | IPv4 prefix                    |
| `[`_IPv6 address_`]` | IPv6 address (see [RFC 5952](https://tools.ietf.org/html/5952))  |
| `[`_IPv6 address_`]/`_NN_ | IPv6 prefix                               |
| `AS`_NNNNNN_       | BGP Autonomous System Number                    |

A *condition* is fundamentally a free-form string; however, the convention
presently used in the PTO uses a hierarchical structure for condition names. A
condition name is made up of condition name elements separated by `.`
characters, where the first element describes the protocol, extension, feature,
or metric to which the condition relates, intermediate levels refer to aspects
or codepoints of the tested feature, and the final level refer to the condition
itself. For example, `ecn.negotiation.succeeded` means that ECN negotiation was
attempted and appeared to be successful. 

## Metadata Elements

JSON objects in the file are treated as metadata key-value pairs, depending on
context (see below). 

# Contexts

Any ndjson file containing 5- or 6-element arrays that can be interpreted as
observations and objects that can be interpreted as metadata is considered a
well-formed obsetvation set file. However, in various contexts, the PTO
provides additional contracts on the file format, as below:

## Observation Access API

With Observation Access API, the observation set ID is filled in on download,
and ignored on upload. Metadata is not present in downloaded files, and is
ignored in uploaded files.

## Results via Query API

Within a query result, the `obs` key contains a JSON array of observations as
in this file format. The observation set ID is present and refers to the
observation set ID within the PTO. Observation set metadata is not present.

## As Analyzer Input

When provided to a local analyzer as input, observation set IDs are
significant. Observations from multiple observation sets are not mixed on
input: first, all observations from one set are read, then all from the next
set, and so on. Metadata is present, and appears directly before the first
observation in each observation set.

## As Analyzer Output

When produced by a local analyzer as output, observation set IDs are ignored.
Multiple metadata elements may be present, but only the last metadata element
present will be taken as metadata for the new observation set.
