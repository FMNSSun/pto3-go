# Observation Set File Format

Observation sets are accessible in the PTO API, and provided to and generated by
analyzers in the analyzer interface, as Observation Set Files (OSF). An OSF is a
newline-delimited JSON (ndjson) file where each line contains either an
observation or an observation set metadata objects.

## Data Elements

JSON arrays in the file are treated as observations. An array has five or six
elements, with the following semantics and format:

| Position | Description                                               |
| -------- | --------------------------------------------------------- |
| 0        | Observation Set Identifier, an integer                    |
| 1        | Start time in ISO8601 format                              |
| 2        | End time in ISO8601 format                                |
| 3        | Path, as a JSON array of strings, one per path element    |
| 4        | Condition, as a JSON string                               |
| 5        | Value associated with condition, optional                 |

*Path elements* are strings identifying hops along the path. The type of path
element is implied by its format; the following path element types are currently
supported:

| Format              | Description                                     |
| ------------------- | ----------------------------------------------- |
| the string `*`      | zero or more unknown hops on a path             |
| _NNN_`.`_NNN_`.`_NNN_`.`_NNN_ | IPv4 address                          |
| _NNN_`.`_NNN_`.`_NNN_`.`_NNN_`/`_NN_ | IPv4 prefix                    |
| `[`_IPv6 address_`]` | IPv6 address (see [RFC 5952](https://tools.ietf.org/html/5952))  |
| `[`_IPv6 address_`]/`_NN_ | IPv6 prefix                               |
| `AS`_NNNNNN_       | BGP Autonomous System Number                    |

A *condition* is fundamentally a free-form string; however, the convention
presently used in the PTO uses a hierarchical structure for condition names. A
condition name is made up of condition name elements separated by `.`
characters, where the first element describes the protocol, extension, feature,
or metric to which the condition relates, intermediate levels refer to aspects
or codepoints of the tested feature, and the final level refer to the condition
itself. For example, `ecn.negotiation.succeeded` means that ECN negotiation was
attempted and appeared to be successful. 

## Metadata Elements

JSON objects in the file are treated as metadata key-value pairs. The `_sources`, `_analyzer`, and `_campaign` elements will be used for provenance. Depending on the context 

# Contexts

Any ndjson file containing 5- or 6-element arrays that can be interpreted as observations and objects that can be interpreted as metadata is considered a well-formed obsetvation set file. However, in various contexts, the PTO provides additional contracts on the file format, as below:

## Observation Access API

observations only, obset ID filled in but always same on download, ignored on upload. no metadata.

## Results via Query API

not NDJSON but observations as array of arrays, obset ID significant, no metadata.

## As Analyzer Input

as from observation access API, but metadata present and guaranteed to be the first element in the file

## As Analyzer Output

as to observation access API, but metadata may be present, last metadata element wins.